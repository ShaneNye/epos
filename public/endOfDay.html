<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPOS End Of Day</title>

    <link rel="stylesheet" href="/assistant/assistant.css" />
    <link rel="stylesheet" href="/css/home.css">
    <script src="/js/storage.js"></script>
    <script src="/js/menu.js"></script>

    <!-- Virtual Sales Assistant -->
    <script src="/assistant/assistant.js"></script>
    <script type="module" src="/assistant/assistantHooks.js"></script>

    <style>
        .eod-wrapper {
            max-width: 900px;
            margin: 2rem auto;
        }

        .eod-step {
            background: #fff;
            border: 1px solid #e3e6ea;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .eod-step h2 {
            margin-top: 0;
            color: var(--brand);
            font-size: 1.3rem;
        }

        .eod-step p {
            color: #555;
            margin-bottom: 16px;
        }

        .eod-btn {
            background: var(--brand);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.1s ease;
            margin-right: 10px;
        }

        .eod-btn:hover {
            background: var(--brand-600);
            transform: translateY(-1px);
        }

        /* Secondary button */
        .eod-btn-secondary {
            background: #6a7480;
        }

        .eod-btn-secondary:hover {
            background: #555;
        }

        /* Coming soon placeholder */
        .coming-soon {
            background: #f5f5f5;
            border: 1px dashed #bbb;
            padding: 18px;
            border-radius: 6px;
            text-align: center;
            color: #777;
            font-style: italic;
            font-size: 1rem;
        }

        .eod-btn-complete {
            background: #2ecc71 !important;
            /* Green */
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .eod-btn-complete::before {
            content: "‚úî";
            font-weight: bold;
        }
      .eod-btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.85;
}

.eod-btn-loading .btn-text {
    opacity: 0.7;
}

/* Spinner container */
.eod-btn-loading::after {
    content: "";
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.6);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}


    </style>
</head>

<body>

    <div id="menu"></div>

    <main class="content">
        <h1>End Of Day</h1>

        <div class="eod-wrapper">

            <!-- STEP 1 -->
            <div class="eod-step">
                <h2>Step 1 ‚Äî Footfall</h2>
                <p>Record the total customer footfall for today before completing end-of-day balancing.</p>

                <button class="eod-btn" id="openFootfallBtn">Enter Footfall</button>
                <button class="eod-btn eod-btn-secondary" id="completeFootfallBtn">
    <span class="btn-text">Complete Today‚Äôs Footfall</span>
</button>
            </div>

            <!-- STEP 2 -->
            <div class="eod-step">
                <h2>Step 2 ‚Äî Daily Balancing</h2>
                <div class="coming-soon">
                    Daily balancing tools will appear here soon.
                </div>
            </div>

        </div>
    </main>
<script>
document.addEventListener("DOMContentLoaded", async () => {

    const authRaw = storageGet?.();
    const token = authRaw?.token || authRaw?.accessToken || null;

    const completeBtn = document.getElementById("completeFootfallBtn");

function setLoading(btn, text) {
    btn.classList.add("eod-btn-loading");
    btn.querySelector(".btn-text").textContent = text;
}

function clearLoading(btn, text) {
    btn.classList.remove("eod-btn-loading");
    btn.querySelector(".btn-text").textContent = text;
}

function openPopup(event) {
    const btn = event.currentTarget;

    setLoading(btn, "Opening‚Ä¶");

    const w = window.open(
        "/eod/footfallPopup.html",
        "FootfallPopup",
        "width=750,height=650,scrollbars=yes,resizable=yes"
    );

    if (w) {
        w.focus();

        const timer = setInterval(() => {
            if (w.closed) {
                clearInterval(timer);

                // Reset text ‚Äî UI will override if already completed
                if (btn.id === "completeFootfallBtn") {
                    clearLoading(btn, "Complete Today‚Äôs Footfall");
                } else {
                    clearLoading(btn, "Enter Footfall");
                }

                window.location.reload();
            }
        }, 500);
    } else {
        // Popup blocked
        clearLoading(btn, "Complete Today‚Äôs Footfall");
    }
}


// Attach handlers
document.getElementById("openFootfallBtn").addEventListener("click", openPopup);
completeBtn.addEventListener("click", openPopup);


    /* -------------------------------------------------
       1Ô∏è‚É£ GET USER FROM /api/me OR FALLBACK
    ------------------------------------------------- */
    let user = null;

    if (token) {
        try {
            const res = await fetch("/api/me", {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data?.ok && data.user) user = data.user;
        } catch (err) {
            console.warn("‚ö†Ô∏è Failed /api/me:", err);
        }
    }

    if (!user) {
        user = authRaw?.user || {};
    }

    const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
    console.log("üë§ User:", fullName, user);

    /* -------------------------------------------------
       2Ô∏è‚É£ GET USER STORE NAME
    ------------------------------------------------- */

    // User store may be: ID, name, or null
    const userStoreRaw =
        user.primaryStore ||
        user.primarystore ||
        user.store ||
        user.storeName ||
        null;

    console.log("üè™ raw user store:", userStoreRaw);

    // If store is numeric ‚Üí lookup location record
    let userStoreName = "";

    if (typeof userStoreRaw === "number") {
        console.log("üîç Store is numeric, fetching locations...");

        try {
            const locRes = await fetch("/api/meta/locations", {
                headers: token ? { Authorization: `Bearer ${token}` } : {}
            });
            const locData = await locRes.json();
            const locations = locData.locations || [];

            const match = locations.find(l => Number(l.id) === Number(userStoreRaw));
            if (match) {
                userStoreName = match.name.includes(":")
                    ? match.name.split(":")[1].trim()
                    : match.name.trim();

                console.log("üè™ Resolved store name:", userStoreName);
            }
        } catch (err) {
            console.error("‚ùå Failed to fetch location names:", err);
        }
    }
    else if (typeof userStoreRaw === "string") {
        userStoreName = userStoreRaw.includes(":")
            ? userStoreRaw.split(":")[1].trim()
            : userStoreRaw.trim();
    }

    if (!userStoreName) {
        console.warn("‚ö†Ô∏è Could not resolve user‚Äôs store name.");
        return;
    }

    /* -------------------------------------------------
       3Ô∏è‚É£ LOAD FOOTFALL DATA
    ------------------------------------------------- */
    let footfall = [];
    try {
        const res = await fetch("/api/eod/footfall", {
            headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        const data = await res.json();
        footfall = data.results || [];
    } catch (err) {
        console.error("‚ùå Failed to load footfall:", err);
        return;
    }

    /* -------------------------------------------------
       4Ô∏è‚É£ MATCH FOOTFALL ROW
    ------------------------------------------------- */
    const todayRow = footfall.find(r => {
        const raw = (r["Store"] || "").replace(/\u00A0/g, " ");
        const clean = raw.includes(":")
            ? raw.split(":")[1].trim()
            : raw.trim();

        return clean.toLowerCase() === userStoreName.toLowerCase();
    });

    if (!todayRow) {
        console.warn("‚ö†Ô∏è No footfall row found for store", userStoreName);
        return;
    }

    console.log("üü¢ Today‚Äôs row:", todayRow);

    /* -------------------------------------------------
       5Ô∏è‚É£ CHECK IF USER IS ASSIGNED
    ------------------------------------------------- */
    const responsibleFields = [
        "Team Leader",
        "Bed Specialist",
        "Bed Specialist 2"
    ];

    const isResponsible = responsibleFields.some(field => {
        const val = todayRow[field];
        return val && val.trim().toLowerCase() === fullName.toLowerCase();
    });

    console.log("üîç User responsible?", isResponsible);

    /* -------------------------------------------------
       6Ô∏è‚É£ UPDATE BUTTON IF RESPONSIBLE
    ------------------------------------------------- */
    if (isResponsible) {
        completeBtn.classList.add("eod-btn-complete");
        completeBtn.textContent = "‚úì Completed Today‚Äôs Footfall";
    }

});
</script>





</body>

</html>