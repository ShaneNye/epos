<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="/assets/moon-man-logo.ico">
  <title>Item Options</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background: #f9fafb;
      color: #333;
    }

    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #0081ab;
    }

    select,
    input[type=number] {
      padding: 6px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.9rem;
      width: 100%;
      box-sizing: border-box;
    }

    select:focus,
    input[type=number]:focus {
      outline: none;
      border-color: #0081ab;
      box-shadow: 0 0 0 2px rgba(0, 129, 171, 0.2);
    }

    .btns {
      margin-top: 20px;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    #saveBtn {
      background: #0081ab;
      color: white;
    }

    #saveBtn:hover {
      background: #006d8f;
    }

    .opt-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin: 12px 0;
      padding: 12px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .opt-group label {
      font-weight: 600;
      color: #111827;
    }
  </style>
</head>

<body>
  <h2>Configure Item Options</h2>
  <form id="optionsForm"></form>
  <div class="btns">
    <button type="button" id="saveBtn">Save</button>
    <button type="button" onclick="window.close()">Cancel</button>
  </div>

  <script>
    function getQueryParams() {
      const params = {};
      new URLSearchParams(window.location.search).forEach((v, k) => params[k] = decodeURIComponent(v));
      return params;
    }

    const { itemId, selections } = getQueryParams();
    const existing = selections ? JSON.parse(selections) : {};

    console.log("ðŸ”Ž Popup opened for itemId:", itemId);
    console.log("ðŸ”Ž Parent cache snapshot:", window.opener?.optionsCache);

    const optionsCache = window.opener?.optionsCache || {};
    const opts = optionsCache[itemId] || {};
    console.log("ðŸ”Ž Options found:", opts);

    const form = document.getElementById("optionsForm");

    Object.entries(opts).forEach(([field, values]) => {
      if (!Array.isArray(values) || values.length === 0) return;

      const fieldLower = String(field).toLowerCase();

      // We only treat it as a special fabric/colour field if the *field name* hints it
      const isFabricColourField =
        fieldLower.includes("fabric") || fieldLower.includes("colour") || fieldLower.includes("color");

      if (isFabricColourField && values.some(v => String(v).includes("|"))) {
        // Normalize strings
        const norm = values.map(v => String(v).trim());

        // Pattern checks:
        // - Full pair: "Fabric|Colour" (something before AND after pipe)
        // - Pipe-only: "|Colour" (pipe at start, colour after)
        const hasFullPair = norm.some(v => /[^|]+\|[^|]+/.test(v));
        const hasPipeOnly = norm.some(v => /^\s*\|[^|]+/.test(v));

        console.log("ðŸŽ¨ Fabric/Colour detection:", {
          field,
          hasFullPair,
          hasPipeOnly,
          sample: norm.slice(0, 6)
        });

        // If no full pairs, but we do have pipe-only, render COLOUR ONLY
        if (!hasFullPair && hasPipeOnly) {
          console.log("ðŸŽ¨ Rendering COLOUR ONLY (values are like '|English Oak')");

          const colours = [];
          norm.forEach(v => {
            // split at first pipe
            const parts = v.split("|");
            const col = (parts[1] || "").trim();
            if (!col) return;
            if (!colours.includes(col)) colours.push(col);
          });

          const group = document.createElement("div");
          group.className = "opt-group";

          const colourLabel = document.createElement("label");
          colourLabel.textContent = "Colour";
          group.appendChild(colourLabel);

          const colourSelect = document.createElement("select");
          colourSelect.name = "colour";
          colourSelect.innerHTML = `<option value="">Select colour...</option>`;

          colours.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            if (existing.colour === c) opt.selected = true;
            colourSelect.appendChild(opt);
          });

          group.appendChild(colourSelect);
          form.appendChild(group);
          return; // â›” done for this field
        }

        // Otherwise, render FABRIC + COLOUR
        console.log("ðŸŽ¨ Rendering FABRIC + COLOUR");

        const fabrics = [];
        const coloursByFabric = {};

        norm.forEach(v => {
          const [fabRaw, colRaw] = v.split("|");
          const fab = (fabRaw || "").trim();
          const col = (colRaw || "").trim();

          // Only accept complete pairs here
          if (!fab || !col) return;

          if (!fabrics.includes(fab)) fabrics.push(fab);
          if (!coloursByFabric[fab]) coloursByFabric[fab] = [];
          if (!coloursByFabric[fab].includes(col)) coloursByFabric[fab].push(col);
        });

        const group = document.createElement("div");
        group.className = "opt-group";

        const fabricLabel = document.createElement("label");
        fabricLabel.textContent = "Fabric";
        group.appendChild(fabricLabel);

        const fabricSelect = document.createElement("select");
        fabricSelect.name = "fabric";
        fabricSelect.innerHTML = `<option value="">Select fabric...</option>`;
        fabrics.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          if (existing.fabric === f) opt.selected = true;
          fabricSelect.appendChild(opt);
        });
        group.appendChild(fabricSelect);

        const colourLabel = document.createElement("label");
        colourLabel.textContent = "Colour";
        group.appendChild(colourLabel);

        const colourSelect = document.createElement("select");
        colourSelect.name = "colour";
        colourSelect.innerHTML = `<option value="">Select colour...</option>`;
        group.appendChild(colourSelect);

        function updateColours() {
          const chosenFabric = fabricSelect.value;
          const colours = coloursByFabric[chosenFabric] || [];
          colourSelect.innerHTML = `<option value="">Select colour...</option>`;
          colours.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            if (existing.colour === c) opt.selected = true;
            colourSelect.appendChild(opt);
          });
        }

        fabricSelect.addEventListener("change", updateColours);

        if (existing.fabric) updateColours();

        form.appendChild(group);
        return; // â›” skip default renderer
      }

      // --- DEFAULT OPTION RENDERER ---
      const group = document.createElement("div");
      group.className = "opt-group";

      const label = document.createElement("label");
      label.textContent = field;
      group.appendChild(label);

      const select = document.createElement("select");
      select.name = field;
      select.innerHTML = `<option value="">Select...</option>`;

      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        if (existing[field] === v) opt.selected = true;
        select.appendChild(opt);
      });

      group.appendChild(select);
      form.appendChild(group);
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
      const selections = {};
      form.querySelectorAll("select").forEach(sel => {
        selections[sel.name] = sel.value || "";
      });

      if (window.opener && typeof window.opener.onOptionsSaved === "function") {
        window.opener.onOptionsSaved(itemId, selections);
      }
      window.close();
    });
  </script>

</body>

</html>
